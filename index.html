<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      /* å…¨ä½“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
      body { font-family: sans-serif; text-align: center; background-color: #f0f0f0; margin: 0; padding: 20px; }
      .screen { display: none; }
      .active { display: block; }
      
      /* ãƒœã‚¿ãƒ³ã‚„å…¥åŠ›æ¬„ */
      input { display: block; margin: 10px auto; padding: 10px; width: 80%; max-width: 300px; font-size: 16px; }
      button { padding: 10px 20px; font-size: 16px; background-color: #ff4757; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
      button:hover { background-color: #ff6b81; }
      
      /* ãƒ›ãƒ¼ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚°ãƒªãƒƒãƒ‰ */
      .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 400px; margin: 20px auto; }
      .menu-btn { height: 100px; font-size: 18px; font-weight: bold; background-color: #3742fa; }
      
      .header { background: #333; color: white; padding: 10px; margin-bottom: 20px; border-radius: 5px; }

      /* ãƒã‚¤ãƒšãƒ¼ã‚¸å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
      .mypage-info { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      .coin-display { font-size: 24px; font-weight: bold; color: gold; text-shadow: 1px 1px 2px #333; }
      .card-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }
      .card-item { border: 2px solid #3742fa; padding: 8px; border-radius: 5px; font-size: 14px; background: #e0e6ff; }
      
      /* ã‚·ãƒ§ãƒƒãƒ—ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .shop-card-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; background: white; border-radius: 5px;}
      .shop-card-item img { width: 50px; height: 50px; object-fit: cover; margin-right: 10px; border: 1px solid #000; }
    </style>
  </head>
  <body>

    <div id="start-screen" class="screen active">
      <h1>ãƒã‚¸ãƒã‚±</h1>
      <button onclick="showScreen('login-screen')">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button onclick="showScreen('signup-screen')">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
    </div>

    <div id="signup-screen" class="screen">
      <h2>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</h2>
      <form id="signup-form">
        <input type="number" name="reg_num" placeholder="å‡ºå¸­ç•ªå· (1-29)" min="1" max="29" required>
        <input type="text" name="reg_name" placeholder="ãƒãƒ¼ãƒ ã‚¿ã‚°" required>
        <input type="password" name="reg_pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ±ºã‚ã¦ã­" required>
        <button type="button" onclick="doRegister()">ä½œæˆã™ã‚‹</button>
      </form>
      <button onclick="showScreen('start-screen')" style="background:#ccc; color:#333;">ã‚‚ã©ã‚‹</button>
    </div>

    <div id="login-screen" class="screen">
      <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <form id="login-form">
        <input type="text" name="login_id" placeholder="ID (ä¾‹: Hajipoke.01)" required>
        <input type="password" name="login_pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
        <button type="button" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³ï¼</button>
      </form>
      <button onclick="showScreen('start-screen')" style="background:#ccc; color:#333;">ã‚‚ã©ã‚‹</button>
    </div>

    <div id="home-screen" class="screen">
      <div class="header">
        <div id="user-display-id">ID: ---</div>
        <div id="user-display-name">åå‰: ---</div>
        <div>ã‚³ã‚¤ãƒ³: <span id="user-coins">0</span> æš</div>
      </div>
      
      <div class="menu-grid">
        <button class="menu-btn" onclick="startPvPSetup()">ãƒãƒˆãƒ«</button>
        <button class="menu-btn" onclick="alert('ã“ã‚Œã‹ã‚‰ã¤ãã‚‹ã‚ˆï¼')">äº¤æ›</button>
        <button class="menu-btn" onclick="showShop()">ã‚·ãƒ§ãƒƒãƒ—</button>
        <button class="menu-btn" onclick="showScreen('earn-screen')">ç¨¼ã</button>
        <button class="menu-btn" onclick="showMypage()">ãƒã‚¤ãƒšãƒ¼ã‚¸</button>
      </div>
    </div>

    <div id="earn-screen" class="screen">
      <h2>ğŸ’° ã‚³ã‚¤ãƒ³ã‚’ç¨¼ã</h2>
      <div class="menu-grid">
        <button class="menu-btn" onclick="startQuiz('kanji')">æ¼¢å­—ã®èª­ã¿ (5å¹´)</button>
        <button class="menu-btn" onclick="startQuiz('anzan')">ã‚ã‚“ã–ã‚“</button>
      </div>
      <button onclick="showScreen('home-screen')" style="background:#ccc; color:#333;">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    </div>

    <div id="quiz-screen" class="screen">
        <div class="header">ã‚¯ã‚¤ã‚ºãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
        <p id="quiz-prompt">å•é¡Œã‚’å–å¾—ä¸­...</p>
        <div id="quiz-area">
            </div>
        <button id="quiz-submit-btn" onclick="checkAnswers()" style="background:#4CAF50; display:none;">ç­”ãˆåˆã‚ã›</button>
        <button id="quiz-return-btn" onclick="showScreen('earn-screen')" style="background:#ccc; color:#333;">ã‚‚ã©ã‚‹</button>
    </div>

    <div id="mypage-screen" class="screen">
      <h2>ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>

      <div class="mypage-info">
        <h3>ç¾åœ¨ã®æ‰€æŒã‚³ã‚¤ãƒ³</h3>
        <div id="mypage-coins" class="coin-display">0 æš</div>
      </div>
      
      <div class="mypage-info">
        <h3>æ‰€æŒã‚«ãƒ¼ãƒ‰ä¸€è¦§</h3>
        <p id="card-count-display">---</p>
        <div id="mypage-card-list" class="card-list">
          </div>
      </div>

      <button onclick="showScreen('home-screen')" style="background:#ccc; color:#333;">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    </div>
    
    <div id="shop-screen" class="screen">
      <h2>ğŸ›ï¸ ã‚·ãƒ§ãƒƒãƒ—</h2>
      <div class="header">
        ç¾åœ¨ã®ã‚³ã‚¤ãƒ³: <span id="shop-current-coins">0</span> æš
      </div>
      <div id="card-shop-list" style="max-width: 600px; margin: 20px auto; text-align: left;">
        <p>ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
      <button onclick="showScreen('home-screen')" style="background:#ccc; color:#333;">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    </div>

    <div id="card-selection-screen" class="screen">
      <h2>ã‚«ãƒ¼ãƒ‰ã‚’é¸ã¼ã† (3æš)</h2>
      <p id="selection-prompt">ç¾åœ¨ã®æ‰€æŒã‚«ãƒ¼ãƒ‰: ---</p>
      <div id="card-selection-list" style="max-width: 500px; margin: 15px auto; text-align: left;">
        </div>
      <button id="start-matching-btn" onclick="requestMatching()" disabled>å¯¾æˆ¦ç›¸æ‰‹ã‚’æ¢ã™</button>
      <button onclick="showScreen('home-screen')" style="background:#ccc; color:#333;">ã‚‚ã©ã‚‹</button>
    </div>

    <div id="pvp-battle-screen" class="screen">
      <h2 id="pvp-title">PvPãƒãƒˆãƒ«</h2>
      <div id="pvp-status-box" style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <p>ãƒãƒˆãƒ«ID: <span id="pvp-battle-id">---</span></p>
        <p>å¯¾æˆ¦ç›¸æ‰‹: <span id="pvp-opponent-id">---</span></p>
        <p>ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: <span id="pvp-turn-display">---</span></p>
      </div>
      
      <div id="pvp-waiting-area" style="display: block;">
        <p id="waiting-message">å¯¾æˆ¦ç›¸æ‰‹ã‚’æ¤œç´¢ä¸­...</p>
        <button onclick="checkMatchingStatus()">çŠ¶æ…‹ã‚’æ›´æ–°</button>
      </div>

      <div id="pvp-active-area" style="display: none;">
        <div id="battle-cards-info"></div>

        <div id="pvp-log-container" style="background: #f0f0f0; padding: 10px; min-height: 80px; text-align: left; margin-bottom: 10px; border-radius: 5px;">
          <p id="pvp-log">ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        </div>
        
        <p id="pvp-action-prompt" style="font-size: 1.1em; font-weight: bold; color: red;">ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚</p>
        
        <button id="pvp-action-btn" onclick="executePvPTurn()" disabled>æ”»æ’ƒå®Ÿè¡Œï¼</button>
        <button onclick="checkMatchingStatus()" style="background:#808080;">çŠ¶æ…‹ã‚’æ›´æ–°</button>
      </div>

      <button id="pvp-exit-btn" onclick="showScreen('home-screen')" style="background:#ccc; color:#333; margin-top: 20px;">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    </div>


    <script>
      // ã€é‡è¦ã€‘ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸGASã®Web APIã®URLã‚’ã“ã“ã«è¨­å®šã—ã¦ãã ã•ã„ï¼
      const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzlA4z4uZNIbZQu0rUxvikqRb5pkcxEo9EqhieuHIzeh5xIjGmrbkQM1Dbk-tjPX8Cb/exec'; 

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼šç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
      let currentUserId = localStorage.getItem('currentUserId') || ''; 
      let currentUserPass = localStorage.getItem('currentUserPass') || '';
      let currentUserNameTag = '';
      let currentUserCoins = 0;
      let currentUserCards = []; // ã‚«ãƒ¼ãƒ‰IDã®é…åˆ—
      
      let currentQuizQuestions = []; // ã‚¯ã‚¤ã‚ºç”¨
      let selectedBattleCards = []; // PvPç”¨
      let currentBattleId = null;   // PvPç”¨

      // åˆæœŸèµ·å‹•æ™‚ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
      document.addEventListener('DOMContentLoaded', () => {
        if (currentUserId && currentUserPass) {
          // å‰å›ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒã‚ã‚Œã°è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦ã¿ã‚‹
          autoLogin(currentUserId, currentUserPass);
        } else {
          showScreen('start-screen');
        }
      });
      
      // =======================================================
      // APIé€šä¿¡ (GASã¨ã®é€£æºã‚’ã™ã¹ã¦ã“ã®é–¢æ•°ã«é›†ç´„)
      // =======================================================

      async function callApi(action, payload = {}) {
          try {
              // èªè¨¼æƒ…å ±ãŒå¿…è¦ãªå ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—
              const authPayload = {
                  action: action,
                  userId: currentUserId,
                  password: currentUserPass,
                  ...payload 
              };

              const response = await fetch(GAS_API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(authPayload)
              });

              const res = await response.json();
              
              if (!res.success && res.message === 'èªè¨¼æƒ…å ±ãŒä¸æ­£ã§ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚') {
                  alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
                  currentUserId = '';
                  currentUserPass = '';
                  localStorage.removeItem('currentUserId');
                  localStorage.removeItem('currentUserPass');
                  showScreen('login-screen');
                  return null;
              }

              if (!res.success) {
                  throw new Error(res.message);
              }

              return res;

          } catch (error) {
              console.error('APIã‚¨ãƒ©ãƒ¼:', error);
              alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
              return null;
          }
      }

      // ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
      function showScreen(id) {
        const screens = document.querySelectorAll('.screen');
        screens.forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
      }

      // UIã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«åˆã‚ã›ã¦æ›´æ–°
      function updateHomeUI() {
          document.getElementById('user-display-id').textContent = 'ID: ' + currentUserId;
          document.getElementById('user-display-name').textContent = 'åå‰: ' + currentUserNameTag;
          document.getElementById('user-coins').textContent = currentUserCoins;
      }
      
      // ----------------------------------------------------
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²æ©Ÿèƒ½
      // ----------------------------------------------------
      
      async function autoLogin(id, pass) {
        const res = await callApi('login', { 
            form: { login_id: id, login_pass: pass }
        });
        
        if (res && res.success) {
            currentUserId = res.userId;
            currentUserNameTag = res.nameTag;
            currentUserCoins = res.coins;
            currentUserCards = res.cards ? res.cards.split(',').filter(c => c.trim() !== '') : []; 
            updateHomeUI();
            showScreen('home-screen');
            if (res.bonusMessage) {
                alert(res.bonusMessage);
            }
        } else {
            showScreen('login-screen');
        }
      }

      async function doRegister() {
        const form = document.getElementById('signup-form');
        const formData = new FormData(form);
        const formObject = Object.fromEntries(formData.entries());
        
        const res = await callApi('register', { form: formObject });
        
        if (res && res.success) {
          alert(res.message);
          showScreen('login-screen');
        }
      }

      async function doLogin() {
        const form = document.getElementById('login-form');
        const formData = new FormData(form);
        const formObject = Object.fromEntries(formData.entries());

        const res = await callApi('login', { form: formObject });
        
        if (res && res.success) {
            // èªè¨¼æƒ…å ±ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
            currentUserId = res.userId;
            currentUserPass = formObject.login_pass;
            localStorage.setItem('currentUserId', res.userId);
            localStorage.setItem('currentUserPass', formObject.login_pass);
            
            currentUserNameTag = res.nameTag;
            currentUserCoins = res.coins;
            currentUserCards = res.cards ? res.cards.split(',').filter(c => c.trim() !== '') : []; 

            updateHomeUI();
            showScreen('home-screen');
            if (res.bonusMessage) {
                alert(res.bonusMessage);
            }
        }
      }
      
      // ----------------------------------------------------
      // ãƒã‚¤ãƒšãƒ¼ã‚¸æ©Ÿèƒ½
      // ----------------------------------------------------
      function showMypage() {
        document.getElementById('mypage-coins').textContent = currentUserCoins + ' æš';
        displayCards();
        showScreen('mypage-screen');
      }

      function displayCards() {
          const cardListDiv = document.getElementById('mypage-card-list');
          cardListDiv.innerHTML = '';
          
          document.getElementById('card-count-display').textContent = 
              'åˆè¨ˆ: ' + currentUserCards.length + ' æš';

          if (currentUserCards.length === 0) {
              cardListDiv.innerHTML = '<p>ã¾ã ã‚«ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚ã‚·ãƒ§ãƒƒãƒ—ã§è²·ã£ã¦ã­ï¼</p>';
              return;
          }

          currentUserCards.forEach(cardId => {
              const cardItem = document.createElement('div');
              cardItem.className = 'card-item';
              cardItem.textContent = cardId; 
              cardListDiv.appendChild(cardItem);
          });
      }


      // ----------------------------------------------------
      // ç¨¼ãæ©Ÿèƒ½
      // ----------------------------------------------------
      
      async function startQuiz(type) {
        showScreen('quiz-screen');
        document.getElementById('quiz-prompt').textContent = type === 'kanji' ? 'æ¼¢å­—ã®èª­ã¿ã‚’ã²ã‚‰ãŒãªã§å…¥åŠ›ã—ã¦ã­ï¼' : 'è¨ˆç®—çµæœã‚’åŠè§’æ•°å­—ã§å…¥åŠ›ã—ã¦ã­ï¼';
        document.getElementById('quiz-submit-btn').style.display = 'none';
        document.getElementById('quiz-area').innerHTML = 'å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...';
        
        const res = await callApi('getQuizQuestions', { quizType: type });
        if (res && res.success) {
            displayQuestions(res.questions);
        } else {
             document.getElementById('quiz-area').innerHTML = '<p>å•é¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
        }
      }

      function displayQuestions(questions) {
        currentQuizQuestions = questions;
        const quizArea = document.getElementById('quiz-area');
        quizArea.innerHTML = '';
        
        if (questions.length === 0) {
            quizArea.innerHTML = '<p>ç¾åœ¨ã€å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¿½åŠ ã—ã¦ãã ã•ã„ï¼</p>';
            document.getElementById('quiz-submit-btn').style.display = 'none';
            return;
        }

        questions.forEach((q, index) => {
          const qDiv = document.createElement('div');
          qDiv.innerHTML = `
            <p>ã€å•é¡Œ${index + 1}ã€‘ ${q.question}</p>
            <input type="text" id="answer-${index}" placeholder="ã“ã“ã«å…¥åŠ›">
          `;
          quizArea.appendChild(qDiv);
        });
        
        document.getElementById('quiz-submit-btn').style.display = 'block';
      }

      async function checkAnswers() {
        let allCorrect = true;
        
        currentQuizQuestions.forEach((q, index) => {
          const input = document.getElementById(`answer-${index}`).value.trim();
          if (input !== q.correctAnswer) {
              allCorrect = false;
          }
        });
        
        if (allCorrect) {
          const res = await callApi('grantCoinReward', { reward: 10 });
          
          if (res && res.success) {
            alert(`ğŸ‰ å…¨å•æ­£è§£ï¼${res.message}`);
            currentUserCoins = res.newCoins;
            updateHomeUI();
            showScreen('earn-screen');
          }
        } else {
          alert(`æ®‹å¿µï¼å…¨å•æ­£è§£ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nãƒªãƒˆãƒ©ã‚¤ã—ã¦ã€å…¨å•æ­£è§£ã‚’ç›®æŒ‡ã—ã¦ã­ï¼`);
          showScreen('earn-screen');
        }
      }

      // ----------------------------------------------------
      // ã‚·ãƒ§ãƒƒãƒ—æ©Ÿèƒ½
      // ----------------------------------------------------
      async function showShop() {
        showScreen('shop-screen');
        document.getElementById('shop-current-coins').textContent = currentUserCoins;
        
        const res = await callApi('getShopCards');
        if (res && res.success) {
            displayShopCards(res.cards);
        } else {
             document.getElementById('card-shop-list').innerHTML = '<p>ã‚·ãƒ§ãƒƒãƒ—æƒ…å ±ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        }
      }

      function displayShopCards(cards) {
        const listDiv = document.getElementById('card-shop-list');
        listDiv.innerHTML = '';
        
        if (cards.length === 0) {
          listDiv.innerHTML = '<p>ç¾åœ¨ã€ã‚·ãƒ§ãƒƒãƒ—ã«ã‚«ãƒ¼ãƒ‰ãŒä¸¦ã‚“ã§ã„ã¾ã›ã‚“ã€‚</p>';
          return;
        }

        cards.forEach(card => {
          const cardHtml = `
            <div class="shop-card-item">
              <div>
                <img src="${card.image || 'https://via.placeholder.com/50'}" alt="${card.name}">
              </div>
              <div style="flex-grow: 1;">
                <strong>${card.name} (${card.id})</strong><br>
                æ”»æ’ƒåŠ›: ${card.attack} / HP: ${card.hp}
              </div>
              <div style="text-align: right;">
                <span style="color: gold; font-weight: bold; font-size: 1.1em;">${card.price} C</span>
                <button 
                  onclick="buyCard('${card.id}', ${card.price})"
                  ${currentUserCoins < card.price ? 'disabled' : ''}
                  style="background-color: ${currentUserCoins < card.price ? '#ccc' : '#4CAF50'}; margin-left: 10px;"
                >
                  è³¼å…¥
                </button>
              </div>
            </div>
          `;
          listDiv.innerHTML += cardHtml;
        });
      }

      async function buyCard(cardId, price) {
        if (!confirm(`${cardId}ã‚’${price}ã‚³ã‚¤ãƒ³ã§è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
          return;
        }

        const res = await callApi('purchaseCard', { cardId: cardId, price: price });
        
        if (res && res.success) {
          alert(res.message);
          
          currentUserCoins = res.newCoins;
          currentUserCards = res.newCards;
            
          updateHomeUI();
          showShop(); // ã‚·ãƒ§ãƒƒãƒ—ãƒªã‚¹ãƒˆã‚’å†è¡¨ç¤º
        }
      }
      
      // ----------------------------------------------------
      // PvPãƒãƒƒãƒãƒ³ã‚°æ©Ÿèƒ½
      // ----------------------------------------------------

      function startPvPSetup() {
          if (currentUserCards.length < 3) {
              alert('PvPãƒãƒˆãƒ«ã«ã¯æœ€ä½3æšã®ã‚«ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚');
              return;
          }
          
          selectedBattleCards = [];
          showScreen('card-selection-screen');
          renderCardSelection();
      }

      function renderCardSelection() {
          const listDiv = document.getElementById('card-selection-list');
          listDiv.innerHTML = '';
          
          document.getElementById('selection-prompt').textContent = 
              `3æšé¸ã‚“ã§ãã ã•ã„ã€‚ (ç¾åœ¨ ${selectedBattleCards.length} / 3 æšé¸æŠä¸­)`;
          
          currentUserCards.forEach(cardId => {
              const isSelected = selectedBattleCards.includes(cardId);
              const btn = document.createElement('button');
              
              btn.textContent = cardId;
              btn.style.margin = '5px';
              btn.style.backgroundColor = isSelected ? '#4CAF50' : '#3742fa';
              
              btn.onclick = () => toggleCardSelection(cardId);
              
              listDiv.appendChild(btn);
          });
          
          document.getElementById('start-matching-btn').disabled = selectedBattleCards.length !== 3;
      }

      function toggleCardSelection(cardId) {
          const index = selectedBattleCards.indexOf(cardId);
          
          if (index > -1) {
              selectedBattleCards.splice(index, 1);
          } else if (selectedBattleCards.length < 3) {
              selectedBattleCards.push(cardId);
          } else {
              alert('ã‚«ãƒ¼ãƒ‰ã¯3æšã¾ã§ã—ã‹é¸ã¹ã¾ã›ã‚“ã€‚');
          }
          renderCardSelection();
      }

      async function requestMatching() {
          showScreen('pvp-battle-screen');
          document.getElementById('pvp-active-area').style.display = 'none';
          document.getElementById('pvp-waiting-area').style.display = 'block';
          document.getElementById('waiting-message').textContent = 'å¯¾æˆ¦ç›¸æ‰‹ã‚’æ¤œç´¢ä¸­...';
          document.getElementById('pvp-exit-btn').style.display = 'block';

          const res = await callApi('enterMatchingQueue', { cardIds: selectedBattleCards });

          if (res && res.success) {
              handleMatchingResponse(res);
          } else {
              document.getElementById('waiting-message').textContent = 'ãƒãƒƒãƒãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã€‚ãƒ›ãƒ¼ãƒ ã«æˆ»ã£ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚';
          }
      }

      function handleMatchingResponse(res) {
          document.getElementById('waiting-message').textContent = res.message;

          if (res.status === 'match_found') {
              alert(res.message);
              checkMatchingStatus(); 
          } else if (res.status === 'waiting') {
              document.getElementById('waiting-message').textContent = res.message + '\n\nã€ŒçŠ¶æ…‹ã‚’æ›´æ–°ã€ãƒœã‚¿ãƒ³ã§ãƒãƒƒãƒãƒ³ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚';
          }
      }

      async function checkMatchingStatus() {
          showScreen('pvp-battle-screen');
          document.getElementById('waiting-message').textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªä¸­...';
          
          const res = await callApi('getCurrentBattleStatus');
          
          if (res && res.success) {
              renderBattleStatus(res);
          } else {
              document.getElementById('waiting-message').textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼ã€‚';
          }
      }

      // ãƒãƒˆãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç”»é¢ã«æç”» (æœ€çµ‚æ›´æ–°ç‰ˆ)
      function renderBattleStatus(status) {
          if (!status.success || status.status === 'none') {
              alert('ãƒãƒˆãƒ«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
              showScreen('home-screen');
              return;
          }
          
          if (status.status === 'waiting') {
              document.getElementById('pvp-active-area').style.display = 'none';
              document.getElementById('pvp-waiting-area').style.display = 'block';
              document.getElementById('waiting-message').textContent = status.message;
              return;
          }
          
          // ãƒãƒˆãƒ«é€²è¡Œä¸­ã®è¡¨ç¤º
          document.getElementById('pvp-waiting-area').style.display = 'none';
          document.getElementById('pvp-active-area').style.display = 'block';
          
          currentBattleId = status.battleId;
          const isMyTurn = status.isMyTurn;
          const isGameOver = status.status === 'P1_WIN' || status.status === 'P2_WIN';
          
          document.getElementById('pvp-battle-id').textContent = status.battleId;
          document.getElementById('pvp-opponent-id').textContent = status.p1Id === currentUserId ? status.p2Id : status.p1Id;
          document.getElementById('pvp-turn-display').textContent = status.turn;
          document.getElementById('pvp-log').innerHTML = status.log;
          
          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¼ãƒ‰æƒ…å ±ã®è¡¨ç¤ºã‚’å°‚ç”¨Divã«æŒ¿å…¥
          const battleCardsInfoDiv = document.getElementById('battle-cards-info');
          battleCardsInfoDiv.innerHTML = `
              <div style="display: flex; justify-content: space-around; text-align: left; margin-bottom: 20px;">
                  <div style="background: #e6ffe6; padding: 10px; border-radius: 5px; width: 45%; border: 2px solid ${isMyTurn ? 'green' : '#ccc'};">
                      <strong>ã‚ãªãŸ (${status.myCard.name})</strong><br>
                      ID: ${status.myCard.id}<br>
                      HP: <span style="color: red; font-weight: bold;">${status.myCard.hp} / ${status.myCard.maxHp}</span><br>
                      ATK: ${status.myCard.atk}
                  </div>
                  <div style="background: #ffe6e6; padding: 10px; border-radius: 5px; width: 45%; border: 2px solid ${!isMyTurn ? 'red' : '#ccc'};">
                      <strong>ãƒ©ã‚¤ãƒãƒ« (${status.opponentCard.name})</strong><br>
                      ID: ${status.opponentCard.id}<br>
                      HP: <span style="color: red; font-weight: bold;">${status.opponentCard.hp} / ${status.opponentCard.maxHp}</span><br>
                      ATK: ${status.opponentCard.atk}
                  </div>
              </div>
          `;

          // ã‚¿ãƒ¼ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ãƒœã‚¿ãƒ³åˆ¶å¾¡
          const promptElement = document.getElementById('pvp-action-prompt');
          const actionBtn = document.getElementById('pvp-action-btn');

          if (isGameOver) {
              promptElement.style.color = 'blue';
              promptElement.textContent = status.log.includes('å‹åˆ©') ? 'ğŸ‰ ãƒãƒˆãƒ«çµ‚äº†ï¼ã‚ãªãŸã®å‹åˆ©ã§ã™ï¼' : 'ğŸ˜­ ãƒãƒˆãƒ«çµ‚äº†ï¼ã‚ãªãŸã®æ•—åŒ—ã§ã™ã€‚';
              actionBtn.style.display = 'none';
              document.getElementById('pvp-exit-btn').style.display = 'block';
          } else {
              promptElement.style.color = isMyTurn ? 'green' : 'red';
              promptElement.textContent = isMyTurn ? 'ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚æ”»æ’ƒã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚' : 'ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¦å¾…ã¡ã¾ã—ã‚‡ã†ã€‚';
              actionBtn.style.display = 'block';
              actionBtn.disabled = !isMyTurn;
              actionBtn.textContent = isMyTurn ? 'æ”»æ’ƒå®Ÿè¡Œï¼' : 'ç›¸æ‰‹ã®è¡Œå‹•å¾…ã¡...';
          }
      }

      // ----------------------------------------------------
      // PvPã‚¿ãƒ¼ãƒ³å®Ÿè¡Œæ©Ÿèƒ½
      // ----------------------------------------------------

      async function executePvPTurn() {
          if (!currentBattleId) {
              alert('ãƒãƒˆãƒ«IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
              return;
          }
          
          document.getElementById('pvp-action-btn').disabled = true;
          document.getElementById('pvp-action-btn').textContent = 'æ”»æ’ƒã‚’å‡¦ç†ä¸­...';
          document.getElementById('pvp-action-prompt').textContent = 'æ”»æ’ƒã‚’å‡¦ç†ä¸­...';

          const res = await callApi('executeTurn', { battleId: currentBattleId });

          if (res && res.success) {
              if (res.status === 'P1_WIN' || res.status === 'P2_WIN') {
                  alert('ãƒãƒˆãƒ«çµ‚äº†ï¼çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
              } else if (res.message === 'ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚') {
                  alert('ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ãŒã¾ã çµ‚äº†ã—ã¦ã„ã¾ã›ã‚“ã€‚');
              } else {
                  alert('æ”»æ’ƒãŒæˆåŠŸã—ã¾ã—ãŸã€‚ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã«ãªã‚Šã¾ã—ãŸã€‚');
              }
              
              // çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯ã—ã¦UIã‚’æ›´æ–°
              checkMatchingStatus(); 
          } else {
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
              document.getElementById('pvp-action-btn').disabled = false;
              document.getElementById('pvp-action-btn').textContent = 'æ”»æ’ƒå®Ÿè¡Œï¼';
              document.getElementById('pvp-action-prompt').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦è©¦ã—ã¦ãã ã•ã„ã€‚';
          }
      }
    </script>
  </body>
</html>